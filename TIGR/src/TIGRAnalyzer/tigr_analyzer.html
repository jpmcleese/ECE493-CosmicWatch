<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIGR Muon Data Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; background: #0f172a; }
        .chart-container { position: relative; height: 300px; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 md:p-8 mb-8 border border-blue-500/20">
                <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400 mb-2">
                    TIGR Muon Data Analyzer
                </h1>
                <p class="text-slate-300 text-sm md:text-base">
                    Upload your raw SD card data to visualize cosmic ray muon detections
                </p>
                
                <div class="mt-6">
                    <input
                        type="file"
                        id="fileInput"
                        accept=".txt,.csv,.dat"
                        class="block w-full text-sm text-slate-300
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-500 file:text-white
                            hover:file:bg-blue-600 cursor-pointer"
                    />
                    <p id="fileName" class="mt-2 text-sm text-cyan-400 hidden"></p>
                </div>
            </div>

            <!-- Stats Cards -->
            <div id="statsCards" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-blue-500/20">
                    <div class="text-slate-400 text-sm mb-1">Total Detections</div>
                    <div id="totalDetections" class="text-3xl font-bold text-blue-400">0</div>
                </div>
                
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-green-500/20">
                    <div class="text-slate-400 text-sm mb-1">Detection Rate</div>
                    <div id="detectionRate" class="text-3xl font-bold text-green-400">0</div>
                    <div class="text-slate-400 text-xs">muons/hour</div>
                </div>
                
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-orange-500/20">
                    <div class="text-slate-400 text-sm mb-1">Avg Temperature</div>
                    <div id="avgTemp" class="text-3xl font-bold text-orange-400">0°C</div>
                    <div id="tempRange" class="text-slate-400 text-xs"></div>
                </div>
                
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-purple-500/20">
                    <div class="text-slate-400 text-sm mb-1">Duration</div>
                    <div id="duration" class="text-3xl font-bold text-purple-400">0</div>
                    <div class="text-slate-400 text-xs">hours</div>
                </div>
            </div>

            <!-- Charts Container -->
            <div id="chartsContainer" class="hidden space-y-8">
                <!-- Energy Distribution -->
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-blue-500/20">
                    <h2 class="text-2xl font-bold text-blue-300 mb-4">Energy Band Distribution</h2>
                    <div class="chart-container">
                        <canvas id="bandChart"></canvas>
                    </div>
                </div>

                <!-- Detection Timeline -->
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-blue-500/20">
                    <h2 class="text-2xl font-bold text-blue-300 mb-4">Detection Timeline</h2>
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>

                <!-- Temperature Chart -->
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-blue-500/20">
                    <h2 class="text-2xl font-bold text-blue-300 mb-4">Temperature During Detections</h2>
                    <div class="chart-container">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-blue-500/20">
                    <h2 class="text-2xl font-bold text-blue-300 mb-4">Recent Detections (Last 20)</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-300">
                            <thead class="text-xs uppercase bg-slate-700/50">
                                <tr>
                                    <th class="px-4 py-3">Muon #</th>
                                    <th class="px-4 py-3">Band</th>
                                    <th class="px-4 py-3">Date</th>
                                    <th class="px-4 py-3">Time</th>
                                    <th class="px-4 py-3">Temp (°C)</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- No Data Message -->
            <div id="noDataMessage" class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-12 border border-blue-500/20 text-center">
                <div class="text-6xl mb-4">📊</div>
                <h3 class="text-2xl font-bold text-slate-300 mb-2">No Data Loaded</h3>
                <p class="text-slate-400 mb-6">Upload your TIGR SD card data file to see visualizations</p>
                <div class="mt-6 text-left max-w-2xl mx-auto bg-slate-900/50 p-6 rounded-lg">
                    <p class="text-sm text-slate-400 mb-2 font-semibold">Expected CSV format:</p>
                    <code class="text-xs text-cyan-400 block whitespace-pre font-mono">Muon#,Band,Date,Time,TempC
1,2,2025-10-09,12:00:15,23
2,1,2025-10-09,12:05:42,23
3,4,2025-10-09,12:12:08,24</code>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('✓ Chart.js loaded:', typeof Chart !== 'undefined');

        let charts = { band: null, timeline: null, temp: null };
        let data = [];

        // Parse CSV data
        function parseData(text) {
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            const parsed = [];
            
            for (let line of lines) {
                if (line.includes('Muon#,Band')) continue;
                if (line.includes('\0')) break;
                
                const parts = line.split(',');
                if (parts.length >= 5) {
                    const muonNum = parseInt(parts[0]);
                    const band = parseInt(parts[1]);
                    const date = parts[2].trim();
                    const time = parts[3].trim();
                    const temp = parseInt(parts[4]);
                    
                    if (!isNaN(muonNum) && !isNaN(band)) {
                        parsed.push({
                            muonNumber: muonNum,
                            energyBand: band,
                            date: date,
                            time: time,
                            temperature: isNaN(temp) ? null : temp,
                            datetime: new Date(`${date} ${time}`)
                        });
                    }
                }
            }
            
            console.log('✓ Parsed', parsed.length, 'readings');
            return parsed;
        }

        // Calculate statistics
        function calculateStats(data) {
            const bandCounts = { 1: 0, 2: 0, 3: 0, 4: 0 };
            let tempSum = 0, tempCount = 0, minTemp = Infinity, maxTemp = -Infinity;
            
            data.forEach(entry => {
                bandCounts[entry.energyBand]++;
                if (entry.temperature !== null) {
                    tempSum += entry.temperature;
                    tempCount++;
                    minTemp = Math.min(minTemp, entry.temperature);
                    maxTemp = Math.max(maxTemp, entry.temperature);
                }
            });
            
            const firstTime = data[0].datetime;
            const lastTime = data[data.length - 1].datetime;
            const durationHours = ((lastTime - firstTime) / (1000 * 60 * 60)).toFixed(2);
            
            return {
                totalDetections: data.length,
                bandCounts,
                avgTemp: tempCount > 0 ? (tempSum / tempCount).toFixed(1) : 'N/A',
                minTemp: tempCount > 0 ? minTemp : 'N/A',
                maxTemp: tempCount > 0 ? maxTemp : 'N/A',
                duration: durationHours,
                detectionRate: durationHours > 0 ? (data.length / parseFloat(durationHours)).toFixed(2) : 'N/A'
            };
        }

        // Update UI
        function updateUI(data, stats) {
            // Show/hide sections
            document.getElementById('noDataMessage').classList.add('hidden');
            document.getElementById('statsCards').classList.remove('hidden');
            document.getElementById('chartsContainer').classList.remove('hidden');
            
            // Update stats cards
            document.getElementById('totalDetections').textContent = stats.totalDetections;
            document.getElementById('detectionRate').textContent = stats.detectionRate;
            document.getElementById('avgTemp').textContent = stats.avgTemp + '°C';
            document.getElementById('tempRange').textContent = `${stats.minTemp}°C to ${stats.maxTemp}°C`;
            document.getElementById('duration').textContent = stats.duration;
            
            // Create charts
            createBandChart(stats.bandCounts);
            createTimelineChart(data);
            createTempChart(data);
            
            // Update table
            updateTable(data);
        }

        // Create band distribution chart
        function createBandChart(bandCounts) {
            const ctx = document.getElementById('bandChart');
            if (charts.band) charts.band.destroy();
            
            charts.band = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Band 1 (Low)', 'Band 2', 'Band 3', 'Band 4 (High)'],
                    datasets: [{
                        label: 'Detections',
                        data: [bandCounts[1], bandCounts[2], bandCounts[3], bandCounts[4]],
                        backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: { 
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        // Create timeline chart
        function createTimelineChart(data) {
            const ctx = document.getElementById('timelineChart');
            if (charts.timeline) charts.timeline.destroy();
            
            // Group by hour
            const grouped = {};
            data.forEach(entry => {
                const hourKey = entry.datetime.toISOString().substring(0, 13);
                grouped[hourKey] = (grouped[hourKey] || 0) + 1;
            });
            
            const labels = Object.keys(grouped);
            const counts = Object.values(grouped);
            
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Detections per Hour',
                        data: counts,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: { 
                            ticks: { color: '#94a3b8', maxRotation: 45 },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        // Create temperature chart
        function createTempChart(data) {
            const ctx = document.getElementById('tempChart');
            if (charts.temp) charts.temp.destroy();
            
            const tempData = data.filter(d => d.temperature !== null);
            const labels = tempData.map((_, i) => i + 1);
            const temps = tempData.map(d => d.temperature);
            
            charts.temp = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: temps,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: {
                        y: { 
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: { 
                            title: { display: true, text: 'Event #', color: '#94a3b8' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        // Update data table
        function updateTable(data) {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            const recent = data.slice(-20).reverse();
            recent.forEach(entry => {
                const bandColors = {
                    1: 'bg-green-500/20 text-green-300',
                    2: 'bg-blue-500/20 text-blue-300',
                    3: 'bg-orange-500/20 text-orange-300',
                    4: 'bg-red-500/20 text-red-300'
                };
                
                const row = `
                    <tr class="border-b border-slate-700 hover:bg-slate-700/30">
                        <td class="px-4 py-3 font-medium">${entry.muonNumber}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${bandColors[entry.energyBand]}">
                                Band ${entry.energyBand}
                            </span>
                        </td>
                        <td class="px-4 py-3">${entry.date}</td>
                        <td class="px-4 py-3">${entry.time}</td>
                        <td class="px-4 py-3">${entry.temperature !== null ? entry.temperature : 'N/A'}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // File upload handler
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            console.log('📁 Loading file:', file.name);
            document.getElementById('fileName').textContent = '📁 Loaded: ' + file.name;
            document.getElementById('fileName').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                data = parseData(e.target.result);
                if (data.length > 0) {
                    const stats = calculateStats(data);
                    updateUI(data, stats);
                }
            };
            reader.readAsText(file);
        });

        console.log('✅ TIGR Analyzer ready!');
    </script>
</body>
</html>